C51 COMPILER V9.60.7.0   DS18B20                                                           09/17/2025 19:21:45 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Objects\ds18b20.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ds18b20.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\d
                    -s18b20.lst) TABS(2) OBJECT(.\Objects\ds18b20.obj)

line level    source

   1          #include <REGX52.H>
   2          #include "intrins.h"
   3          #include "delay.h"
   4          
   5          sbit singlebus = P3^7;
   6          
   7          void singlebus_reset()
   8          {
   9   1        singlebus = 0;
  10   1        delay_10us(75);
  11   1        singlebus = 1;
  12   1        delay_10us(2);
  13   1      }
  14          
  15          unsigned char check_edge()
  16          {
  17   1        unsigned char timeout = 0;
  18   1        while(singlebus && timeout < 20)
  19   1        {
  20   2          timeout++;
  21   2          delay_10us(1);
  22   2        }
  23   1        if(timeout >= 20)
  24   1        {
  25   2          return 1;
  26   2        }
  27   1        timeout = 0;
  28   1        while((!singlebus) && timeout < 20)
  29   1        {
  30   2          timeout++;
  31   2          delay_10us(1);
  32   2        }
  33   1        if(timeout >= 20)
  34   1        {
  35   2          return 1;
  36   2        }
  37   1        return 0;
  38   1      }
  39          
  40          unsigned char singlebus_Init()
  41          {
  42   1        singlebus_reset();
  43   1        return check_edge();
  44   1      }
  45          
  46          void singlebus_writebyte(unsigned char dat)
  47          {
  48   1        unsigned char i;
  49   1        for(i = 0;i < 8;i++)
  50   1        {
  51   2          if(dat&(0x01 << i))
  52   2          {
  53   3            singlebus = 0;
  54   3            _nop_();
C51 COMPILER V9.60.7.0   DS18B20                                                           09/17/2025 19:21:45 PAGE 2   

  55   3            _nop_();
  56   3      //      _nop_();
  57   3            singlebus = 1;
  58   3            delay_10us(6);
  59   3          }
  60   2          else
  61   2          {
  62   3            singlebus = 0;
  63   3            delay_10us(6);
  64   3            singlebus = 1;
  65   3            _nop_();
  66   3            _nop_();
  67   3      //      _nop_();
  68   3          }
  69   2        }
  70   1      }
  71          
  72          unsigned char singlebus_read_bit(void)
  73          {
  74   1        unsigned char dat=0;
  75   1        
  76   1        singlebus=0;
  77   1        _nop_();_nop_();
  78   1        singlebus=1;  
  79   1        _nop_();_nop_(); //该段时间不能过长，必须在15us内读取数据
  80   1        if(singlebus)dat=1; //如果总线上为1则数据dat为1，否则为0
  81   1        else dat=0;
  82   1        delay_10us(5);
  83   1        return dat;
  84   1      } 
  85          
  86          unsigned char singlebus_readbyte()
  87          {
  88   1        unsigned char i, temp = 0, dat = 0;
  89   1        for(i = 0;i < 8;i++)
  90   1        {
  91   2          dat >>= 1;
  92   2          singlebus = 0;
  93   2          _nop_();
  94   2          _nop_();
  95   2          singlebus = 1;
  96   2          _nop_();
  97   2          _nop_();
  98   2          if(singlebus)
  99   2          {
 100   3            dat |= 0x80;    
 101   3          }
 102   2          delay_10us(5);
 103   2        }
 104   1        return dat;
 105   1      }
 106          
 107          float ds18b20_readtemperature()
 108          {
 109   1        unsigned char dat_l, dat_h;
 110   1        unsigned int dat;
 111   1        float temp;
 112   1        
 113   1        singlebus_Init();
 114   1        singlebus_writebyte(0xcc);
 115   1        singlebus_writebyte(0x44);
 116   1        singlebus_Init();
C51 COMPILER V9.60.7.0   DS18B20                                                           09/17/2025 19:21:45 PAGE 3   

 117   1        singlebus_writebyte(0xcc);  
 118   1        singlebus_writebyte(0xbe);
 119   1        
 120   1        dat_l = singlebus_readbyte();
 121   1        dat_h = singlebus_readbyte();
 122   1      
 123   1        dat = (dat_h << 8) | dat_l;
 124   1        
 125   1        if((dat_h & 0xf8) == 0xf8)
 126   1        {
 127   2          temp = (~dat + 1) * (-0.0625);
 128   2        }
 129   1        else
 130   1        {
 131   2          temp = dat * 0.0625;
 132   2        }
 133   1      
 134   1        
 135   1        return temp;
 136   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    355    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
